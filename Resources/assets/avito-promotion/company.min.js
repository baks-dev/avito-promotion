executeFunc(function initAvitoPromotion(){const avitoPromotionForm=document.forms.avito_promotion_form;let categoryElement=document.getElementById("avito_promotion_form_category");if(categoryElement===null){return false}categoryElement.addEventListener("change",function(event){document.getElementById("categoryName").innerHTML="";changeCategory(avitoPromotionForm)});let filterCollectionBtnAdd=document.getElementById("filterCollection_add");const form=new FormData(document.forms.avito_promotion_form);currentCategory=form.get("avito_promotion_form[category]");document.getElementById("filterCollection_add").disabled=true;deleteItemsStorage=new Map;filterCollectionBtnAdd.addEventListener("click",addItem);const currentDeleteBtns=document.getElementById("filterCollection").querySelectorAll(".del-item-filter");if(currentDeleteBtns){deleteItem(currentDeleteBtns)}document.querySelectorAll(".js-datepicker").forEach(datepicker=>{MCDatepicker.create({el:"#"+datepicker.id,bodyType:"modal",autoClose:false,closeOndblclick:true,closeOnBlur:false,customOkBTN:"OK",customClearBTN:datapickerLang[$locale].customClearBTN,customCancelBTN:datapickerLang[$locale].customCancelBTN,firstWeekday:datapickerLang[$locale].firstWeekday,dateFormat:"DD.MM.YYYY",customWeekDays:datapickerLang[$locale].customWeekDays,customMonths:datapickerLang[$locale].customMonths})});return true});function addItem(){const predicateSelect=document.getElementById("avito_promotion_form_predicatePrototype");if(predicateSelect){predicateSelect.value=predicateData}let filterCollectionBlock=document.getElementById("filterCollection");itemKey=this.dataset.index;if(deleteItemsStorage.size>0){let last="";deleteItemsStorage.forEach(function(value){last=value});itemKey=last;deleteItemsStorage.delete("key"+last)}let prototypeName=this.dataset.prototype;const prototypeElement=document.getElementById(prototypeName);let prototypeContent=prototypeElement.dataset.prototype;let index=parseInt(this.dataset.index)+1;this.setAttribute("data-index",index);const limit=8;if(parseInt(this.dataset.index)>limit){this.setAttribute("data-index",limit);return}prototypeContent=prototypeContent.replace(/__filters__/g,itemKey);const parser=new DOMParser;const result=parser.parseFromString(prototypeContent,"text/html");let prototypePreProperty=result.getElementById("prototypeProperty").querySelector("input");prototypePreProperty.setAttribute("value",currentPropertyData);let prototypePreValue=result.getElementById("prototypeValue").querySelector("input");prototypePreValue.setAttribute("value",preValueData);let prototypePredicate=result.getElementById("prototypePredicate").querySelector("input");prototypePredicate.setAttribute("value",predicateData);let itemDiv=document.createElement("div");itemDiv.setAttribute("id","avito_promotion_form_filters_"+itemKey);itemDiv.classList.add("item-filter");itemDiv.append(prototypePreProperty);itemDiv.append(prototypePreValue);itemDiv.append(prototypePredicate);let newTitle=document.createElement("div");newTitle.classList.add("w-100");newTitle.innerHTML=titleItem();const categorySelect=document.getElementById("avito_promotion_form_category");let categoryTitle=document.getElementById("categoryName");if(categorySelect.querySelector(`[value="${categoryData}"]`).innerHTML){categoryTitle.innerHTML=categorySelect.querySelector(`[value="${categoryData}"]`).innerHTML}itemDiv.append(newTitle);filterCollectionBlock.append(itemDiv);let deleteBtns=filterCollectionBlock.querySelectorAll(".del-item-filter");deleteItem(deleteBtns)}function deleteItem(buttons){buttons.forEach(function(btn){btn.addEventListener("click",function(){const itemForDelete=document.getElementById(btn.id.replace(/delete-/g,""));const deleteIndex=btn.id.replace(/delete-avito_promotion_form_filters_/g,"");deleteItemsStorage.set("key"+deleteIndex,deleteIndex);if(itemForDelete){itemForDelete.remove();let addBtn=document.getElementById("filterCollection_add");const newIndex=parseInt(addBtn.dataset.index)-1;addBtn.setAttribute("data-index",newIndex)}})})}function titleItem(){const titleTemplate=document.getElementById("title_prototype");let newTitle=titleTemplate.dataset.prototype;newTitle=newTitle.replace(/__key__/g,itemKey);newTitle=newTitle.replace(/__number__/g,parseInt(itemKey)+1);const prePropertySelect=document.getElementById("avito_promotion_form_preProperty");if(prePropertySelect.querySelector(`[value="${currentPropertyData}"]`).innerHTML){newTitle=newTitle.replace(/__title__property__/g,prePropertySelect.querySelector(`[value="${currentPropertyData}"]`).innerHTML)}const predicateSelect=document.getElementById("avito_promotion_form_predicatePrototype");newTitle=newTitle.replace(/__title__predicate__/g,predicateSelect.querySelector(`[value="${predicateData}"]`).innerHTML);const preValueForm=document.getElementById("avito_promotion_form_preValue");if(preValueForm.value){if(preValueForm.value==="1"){newTitle=newTitle.replace(/__title__value__/g,"есть")}else{newTitle=newTitle.replace(/__title__value__/g,preValueForm.value)}return newTitle}const preValue=preValueForm.querySelector(`[value="${preValueData}"]`);if(preValue.value){let parent=preValueForm.querySelector(`[value="${preValueData}"]`).parentElement;newTitle=newTitle.replace(/__title__value__/g,parent.querySelector("label").innerHTML);return newTitle}if(preValueForm.querySelector(`[value="${preValueData}"]`).innerHTML){newTitle=newTitle.replace(/__title__value__/g,preValueForm.querySelector(`[value="${preValueData}"]`).innerHTML);return newTitle}}async function changeCategory(form){const data=new FormData(form);data.delete(form.name+"[_token]");categoryData=data.get("avito_promotion_form[category]");await fetch(form.action,{method:form.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}return response.text()}).then(data=>{if(data){if(!currentCategory||categoryData!==currentCategory){let currentFilterCollection=document.getElementById("filterCollection").querySelectorAll(".item-filter");if(currentFilterCollection.length>0){currentFilterCollection.forEach(function(item){document.getElementById("filterCollection_add").dataset.index=0;item.remove()})}}const result=parseFormData(data);let currentPreValue=document.getElementById("avito_promotion_form_preValue");if(currentPreValue.type!=="hidden"){document.getElementById("avito_promotion_form_preValue").replaceWith(result.getElementById("avito_promotion_form_preValue"))}let current=document.getElementById("avito_promotion_form_preProperty");let postSubmit=result.getElementById("avito_promotion_form_preProperty");if(postSubmit){current.replaceWith(postSubmit)}postSubmit.addEventListener("change",function(event){document.getElementById("preValueContainer").remove();document.getElementById("predicatePrototypeContainer").remove();changePreProperty(document.forms.avito_promotion_form)})}})}async function changePreProperty(form){disabledElementsForm(form);const data=new FormData(form);data.delete(form.name+"[_token]");currentPropertyData=data.get("avito_promotion_form[preProperty]");await fetch(form.action,{method:form.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}return response.text()}).then(data=>{if(data){const result=parseFormData(data);let postSubmit=result.getElementById("preValue");if(postSubmit){document.getElementById("preValue").replaceWith(postSubmit)}postSubmit.addEventListener("change",function(event){changePreValue(document.forms.avito_promotion_form)});let postSubmitPredicate=result.getElementById("predicatePrototype");if(postSubmitPredicate){document.getElementById("predicatePrototype").replaceWith(postSubmitPredicate)}const form=new FormData(document.forms.avito_promotion_form);predicateData=form.get("avito_promotion_form[predicatePrototype]");postSubmitPredicate.addEventListener("change",function(event){changePredicate(document.forms.avito_promotion_form)})}})}function changePreValue(form){const data=new FormData(form);data.delete(form.name+"[_token]");preValueData=data.get("avito_promotion_form[preValue]");if(preValueData==="1"){preValueData="true"}if(preValueData){document.getElementById("filterCollection_add").disabled=false;enableElementsForm(form)}else{document.getElementById("filterCollection_add").disabled=true}}function changePredicate(form){const data=new FormData(form);predicateData=data.get("avito_promotion_form[predicatePrototype]")}function parseFormData(data){const parser=new DOMParser;return parser.parseFromString(data,"text/html")}